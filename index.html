<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bid Comparison Application</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .variance-input-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .variance-input-label {
        font-size: 0.875rem; /* text-sm */
        font-weight: 500;
        color: #374151; /* text-gray-700 */
      }

      .variance-input {
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db; /* border-gray-300 */
        border-radius: 0.375rem; /* rounded-md */
        font-size: 0.875rem;
        color: #111827; /* text-gray-900 */
        outline: none;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      }

      .variance-input:focus {
        border-color: #6366f1; /* indigo-500 */
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); /* focus ring */
      }

      .variance-legend {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 1.5rem;
        margin: 1rem 1rem 0 0;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151; /* text-gray-700 */
      }

      .variance-box {
        width: 1.5rem;
        height: 1.5rem;
        border: 2px solid;
        border-radius: 0.375rem;
      }

      .variance-low {
        background-color: #cce5ff; /* Light Blue */
        border-color: #007bff;
      }

      .variance-high {
        background-color: #ffe5b4; /* Light Orange */
        border-color: #ff9900;
      }

      .scroll-wrapper {
        position: relative;
        width: 100%;
      }

      .top-scrollbar {
        overflow-x: auto;
        overflow-y: hidden;
        height: 16px;
        position: sticky;
        top: 0;
        z-index: 50;
        background: white;
      }

      .top-scrollbar-inner {
        height: 1px;
      }

      .bg-blue-100 {
        background-color: #cce5ff; /* Light blue */
      }

      .bg-orange-100 {
        background-color: #ffe5b4; /* Light orange */
      }

      /* Optional: to enhance visibility */
      .rate-input.bg-blue-100 {
        border: 1px solid #007bff;
      }

      .rate-input.bg-orange-100 {
        border: 1px solid #ff9900;
      }
      body {
        font-family: "Inter", sans-serif;
      }
      .tab-button.active {
        border-color: #4f46e5;
        background-color: #eef2ff;
        color: #4f46e5;
        font-weight: 600;
      }
      .table-container {
        width: 100%;
        overflow-x: auto;
      }
      table {
        width: max-content;
        min-width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #e5e7eb;
        padding: 8px;
        text-align: left;
        font-size: 12px;
        white-space: nowrap;
      }
      td:nth-child(2) {
        /* Description column */
        white-space: normal;
        min-width: 300px;
      }
      th {
        background-color: #f3f4f6;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .rate-input {
        width: 80px;
        padding: 4px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        text-align: right;
      }
      .rate-input:disabled {
        background-color: #f3f4f6;
        border-color: transparent;
      }
      .amount-cell,
      .total-cell,
      .least-amount-cell {
        text-align: right;
      }
      .subtotal-row {
        font-weight: bold;
        background-color: #fde68a; /* Amber-200 for highlighting */
      }
      .grand-total-row {
        font-weight: bold;
        background-color: #a7f3d0; /* Emerald-200 for highlighting */
        font-size: 14px;
      }
      .category-header {
        font-weight: bold;
        background-color: #e0e7ff; /* Indigo-100 */
      }
      .least-rate-cell,
      .least-amount-cell {
        background-color: #dcfce7 !important; /* Green-100 */
        font-weight: bold;
      }
    </style>
  </head>
  <body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
      <header class="text-center mb-10">
        <h1
          class="text-4xl font-extrabold text-gray-900 tracking-tight sm:text-5xl"
        >
          ðŸ“Š Bid Comparison Tool
        </h1>
        <p class="mt-4 text-lg text-gray-600">
          Upload your estimate and bidder Excel sheets to generate a detailed
          comparative statement.
        </p>
      </header>

      <!-- File Upload Section -->
      <div
        id="upload-section"
        class="bg-white p-8 rounded-2xl shadow-lg mb-10 border border-gray-200"
      >
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <!-- Estimate File Upload -->
          <div class="space-y-2">
            <label
              for="estimate-file"
              class="block text-sm font-medium text-gray-700"
            >
              ðŸ“„ Estimate File (Baseline)
            </label>
            <input
              type="file"
              id="estimate-file"
              accept=".xlsx"
              class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 focus:outline-none"
            />
          </div>
          <!-- Bidder Files Upload -->
          <div class="space-y-2">
            <label
              for="bidder-files"
              class="block text-sm font-medium text-gray-700"
            >
              ðŸ‘¥ Bidder Files (Max 7)
            </label>
            <input
              type="file"
              id="bidder-files"
              accept=".xlsx"
              multiple
              class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100 focus:outline-none"
            />
          </div>
        </div>

        <!-- Variance Controls -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="variance-input-group">
            <label for="lower-variance" class="variance-input-label"
              >ðŸ“‰ Lower Variance Factor</label
            >
            <input
              type="number"
              id="lower-variance"
              step="0.01"
              min="0"
              max="1"
              value="0.8"
              class="variance-input"
            />
            <small class="text-gray-400 mt-1"
              >e.g., 0.8 means -20% below estimate</small
            >
          </div>
          <div class="variance-input-group">
            <label for="upper-variance" class="variance-input-label"
              >ðŸ“ˆ Upper Variance Factor</label
            >
            <input
              type="number"
              id="upper-variance"
              step="0.01"
              min="1"
              max="2"
              value="1.2"
              class="variance-input"
            />
            <small class="text-gray-400 mt-1"
              >e.g., 1.2 means +20% above estimate</small
            >
          </div>
        </div>



        <!-- Action Buttons -->
        <div class="mt-10 flex flex-wrap justify-center gap-6">
          <button
            id="process-button"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition"
          >
            ðŸš€ Generate Comparison
          </button>
          <button
            id="download-button"
            class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hidden transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
          >
            ðŸ“¥ Download as Excel
          </button>
        </div>




          <!-- Loader -->
  <div id="loader" class="text-center mt-6 hidden">
    <div role="status" class="flex flex-col items-center gap-2">
      <svg
        class="w-8 h-8 text-indigo-600 animate-spin"
        viewBox="0 0 100 101"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591..."
          fill="currentColor"
        />
      </svg>
      <p class="text-sm text-gray-600">Processing files, please wait...</p>
    </div>
  </div>
</div>
      </div>

      <!-- Comparison Output Section -->
      <div id="output-section" class="hidden">
        <div class="border-b border-gray-200">
          <nav
            id="tabs-container"
            class="-mb-px flex space-x-4 overflow-x-auto"
            aria-label="Tabs"
          ></nav>
        </div>
        <div class="variance-legend">
          <div class="flex items-center gap-2">
            <div class="variance-box variance-low"></div>
            <span id="lower-variance-label">0.8</span>
          </div>
          <div class="flex items-center gap-2">
            <div class="variance-box variance-high"></div>
            <span id="upper-variance-label">1.2</span>
          </div>
        </div>

        <div
          id="tables-container"
          class="mt-4 bg-white p-4 rounded-lg shadow-md"
        ></div>
      </div>
    </div>

    <script>
      function getVarianceThresholds() {
        const lowerInput =
          parseFloat(document.getElementById("lower-variance").value) || 0.8;
        const upperInput =
          parseFloat(document.getElementById("upper-variance").value) || 1.2;
        return { lower: lowerInput, upper: upperInput };
      }

      // --- CONFIGURATION ---
      const SHEET_NAMES = [
        "Summary",
        "BOQ-Main Bldg",
        "BOQ-Other Buildings",
        "BOQ-Admin&Other Buildings",
        "BOQ-I Roads& Drains",
        "BOQ-Compound Wall",
        "BOQ-UG Sump",
      ];
      const DATA_CONFIG = {
        // For Bidder Files
        "BOQ-Main Bldg": {
          startRow: 5,
          slNoCol: 0,
          descCol: 1,
          unitCol: 2,
          qtyCol: 3,
          rateCol: 4,
          amountCol: 5,
        },
        "BOQ-Admin&Other Buildings": {
          startRow: 5,
          slNoCol: 0,
          descCol: 1,
          unitCol: 2,
          qtyCol: 3,
          rateCol: 4,
          amountCol: 5,
        },
        "BOQ-Other Buildings": {
          startRow: 5,
          slNoCol: 0,
          descCol: 1,
          unitCol: 2,
          qtyCol: 3,
          rateCol: 4,
          amountCol: 5,
        },
        "BOQ-I Roads& Drains": {
          startRow: 5,
          slNoCol: 0,
          descCol: 1,
          unitCol: 2,
          qtyCol: 3,
          rateCol: 4,
          amountCol: 5,
        },
        "BOQ-Compound Wall": {
          startRow: 3,
          slNoCol: 0,
          descCol: 1,
          unitCol: 2,
          qtyCol: 3,
          rateCol: 4,
          amountCol: 5,
        },
        "BOQ-UG Sump": {
          startRow: 5,
          slNoCol: 0,
          descCol: 1,
          unitCol: 2,
          qtyCol: 3,
          rateCol: 4,
          amountCol: 5,
        },
      };
      const ESTIMATE_CONFIG = {
        // For Estimate File
        "BOQ-Main Bldg": {
          startRow: 5,
          slNoCol: 0,
          descCol: 1,
          unitCol: 2,
          qtyCol: 3,
          rateCol: 4,
          amountCol: 5,
        },
        "BOQ-Admin&Other Buildings": {
          startRow: 5,
          slNoCol: 0,
          descCol: 1,
          unitCol: 2,
          qtyCol: 3,
          rateCol: 4,
          amountCol: 5,
        },
        "BOQ-I Roads& Drains": {
          startRow: 5,
          slNoCol: 0,
          descCol: 1,
          unitCol: 2,
          qtyCol: 3,
          rateCol: 4,
          amountCol: 5,
        },
        "BOQ-Compound Wall": {
          startRow: 4,
          slNoCol: 0,
          descCol: 1,
          unitCol: 2,
          qtyCol: 3,
          rateCol: 4,
          amountCol: 5,
        },
        "BOQ-UG Sump": {
          startRow: 5,
          slNoCol: 0,
          descCol: 1,
          unitCol: 2,
          qtyCol: 3,
          rateCol: 4,
          amountCol: 5,
        },
      };

      let consolidatedData = {};
      let bidderNames = [];

      // --- DOM ELEMENTS ---
      const processButton = document.getElementById("process-button");
      const downloadButton = document.getElementById("download-button");
      const estimateFileInput = document.getElementById("estimate-file");
      const bidderFilesInput = document.getElementById("bidder-files");
      const outputSection = document.getElementById("output-section");
      const loader = document.getElementById("loader");

      // --- EVENT LISTENERS ---
      processButton.addEventListener("click", handleProcessFiles);
   downloadButton.addEventListener("click", handleDownloadExcelJS);

      // --- CORE LOGIC ---
      async function handleProcessFiles() {
        const estimateFile = estimateFileInput.files[0];
        const bidderFiles = bidderFilesInput.files;
        if (!estimateFile || bidderFiles.length === 0) {
          alert("Please select an estimate file and at least one bidder file.");
          return;
        }
        if (bidderFiles.length > 7) {
          alert("You can select a maximum of 7 bidder files.");
          return;
        }

        loader.classList.remove("hidden");
        outputSection.classList.add("hidden");

        try {
          bidderNames = Array.from(bidderFiles).map((f) =>
            f.name.split(".")[0].replace("DGG_BIDDER_", "BIDDER ")
          );
          const estimateData = await parseExcelFile(estimateFile, true);
          const biddersData = await Promise.all(
            Array.from(bidderFiles).map((file) => parseExcelFile(file, false))
          );
          consolidateAllData(estimateData, biddersData);
          const { lower, upper } = getVarianceThresholds();
          document.getElementById("lower-variance-label").textContent = lower;
          document.getElementById("upper-variance-label").textContent = upper;
          renderUI();
          outputSection.classList.remove("hidden");
          downloadButton.classList.remove("hidden");
        } catch (error) {
          console.error("Error processing files:", error);
          alert(
            "An error occurred while processing the files. Please check the console for details."
          );
        } finally {
          loader.classList.add("hidden");
        }
      }

      

      function parseExcelFile(file, isEstimate) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const workbook = XLSX.read(e.target.result, { type: "binary" });
              const parsedSheets = {};
              workbook.SheetNames.forEach((sheetName) => {
                const relevantSheetName = getRelevantSheetName(sheetName);
                if (relevantSheetName) {
                  const config = isEstimate
                    ? ESTIMATE_CONFIG[relevantSheetName]
                    : DATA_CONFIG[relevantSheetName];
                  if (config) {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                      header: 1,
                      range: config.startRow - 1,
                    });
                    parsedSheets[relevantSheetName] = jsonData;
                  }
                }
              });
              resolve(parsedSheets);
            } catch (err) {
              reject(err);
            }
          };
          reader.onerror = reject;
          reader.readAsBinaryString(file);
        });
      }

      function getRelevantSheetName(fileName) {
        if (
          fileName.includes("BOQ-Other Buildings") ||
          fileName.includes("BOQ-Admin&Other Buildings")
        )
          return "BOQ-Admin&Other Buildings";
        return SHEET_NAMES.find((name) => fileName.includes(name));
      }

      function consolidateAllData(estimateData, biddersData) {
        consolidatedData = {};
        for (const sheetName in estimateData) {
          if (sheetName === "Summary") continue;
          const estimateConfig = ESTIMATE_CONFIG[sheetName];
          const bidderConfig = DATA_CONFIG[sheetName];

          consolidatedData[sheetName] = estimateData[sheetName]
            .map((row) => {
              const slNo = row[estimateConfig.slNoCol]
                ? String(row[estimateConfig.slNoCol]).trim()
                : "";
              const description = row[estimateConfig.descCol] || "";
              if (!slNo && !description) return null;

              const item = {
                slNo,
                description,
                unit: row[estimateConfig.unitCol] || "",
                qty: parseQty(row[estimateConfig.qtyCol]),
                estimate: {
                  rate: parseFloat(row[estimateConfig.rateCol]) || 0,
                  amount: 0,
                }, // Amount will be calculated
                bidders: [],
                isSubtotal: description.toLowerCase().includes("sub-total"),
                isGrandTotal:
                  description.toUpperCase().includes("GRAND TOTAL") ||
                  description.toUpperCase().includes("TOTAL AMOUNT"),
                isCategory:
                  !String(slNo).includes(".") && !isNaN(parseFloat(slNo)),
              };

              biddersData.forEach((bidder, index) => {
                const bidderSheet = bidder[sheetName];
                let bidderRate = 0;
                if (bidderSheet) {
                  const estimateSlNo = (slNo || "")
                    .replace(/\s+/g, "")
                    .toLowerCase();

                  const bidderRow = bidderSheet.find((bRow) => {
                    const bidderSl = String(bRow[bidderConfig.slNoCol] || "")
                      .replace(/\s+/g, "")
                      .toLowerCase();
                    return bidderSl === estimateSlNo;
                  });

                  if (bidderRow)
                    bidderRate =
                      parseFloat(bidderRow[bidderConfig.rateCol]) || 0;
                }
                item.bidders.push({
                  name: bidderNames[index],
                  rate: bidderRate,
                  amount: 0,
                }); // Amount will be calculated
              });
              return item;
            })
            .filter(Boolean);
        }
        calculateAllTotals();
      }

      function parseQty(value) {
        if (typeof value === "string" && value.toUpperCase() === "QRO")
          return 0;
        const num = parseFloat(value);
        return isNaN(num) ? 0 : num;
      }

      // --- UI Rendering ---
      function renderUI() {
        renderTabs();
        const firstSheet = SHEET_NAMES.find(
          (name) => consolidatedData[name] || name === "Summary"
        );
        renderTableForSheet(firstSheet);
        document.querySelector(".tab-button").classList.add("active");
      }

      function renderTabs() {
        const tabsContainer = document.getElementById("tabs-container");
        tabsContainer.innerHTML = "";
        const displaySheets = SHEET_NAMES.filter(
          (name) =>
            name === "Summary" ||
            (consolidatedData[name] && consolidatedData[name].length > 0)
        );
        displaySheets.forEach((sheetName) => {
          const button = document.createElement("button");
          button.textContent = sheetName.replace("BOQ-", "");
          button.className =
            "tab-button border-b-2 border-transparent py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300";
          button.dataset.sheet = sheetName;
          button.addEventListener("click", (e) => {
            document
              .querySelectorAll(".tab-button")
              .forEach((btn) => btn.classList.remove("active"));
            e.target.classList.add("active");
            renderTableForSheet(sheetName);
          });
          tabsContainer.appendChild(button);
        });
      }

      function renderTableForSheet(sheetName) {
        const tablesContainer = document.getElementById("tables-container");
        tablesContainer.innerHTML = "";
        const data =
          sheetName === "Summary"
            ? consolidatedData.Summary
            : consolidatedData[sheetName];
        if (!data) {
          tablesContainer.innerHTML = `<p>No data available for ${sheetName}.</p>`;
          return;
        }

        const tableWrapper = document.createElement("div");
        tableWrapper.className = "table-container";
        const table = document.createElement("table");
        table.id = `table-${sheetName.replace(/\s|&/g, "-")}`;

        const thead = document.createElement("thead");
        const tbody = document.createElement("tbody");

        if (sheetName === "Summary") {
          thead.innerHTML = `<tr><th>Sl. No</th><th>Description</th><th>Estimate Amount</th>
                    ${bidderNames
                      .map((name) => `<th>${name} Amount</th>`)
                      .join("")}<th>Least Amount</th></tr>`;
          tbody.innerHTML = data

            .map(
              (row) => `
                    <tr class="${row.isTotal ? "grand-total-row" : ""}">
                        <td>${row.slNo}</td><td>${row.description}</td>
                        <td class="amount-cell">${formatCurrency(
                          row.estimateAmount
                        )}</td>
                        ${bidderNames
                          .map(
                            (_, i) =>
                              `<td class="amount-cell">${formatCurrency(
                                row.bidderAmounts[i]
                              )}</td>`
                          )
                          .join("")}
                        <td class="least-amount-cell">${formatCurrency(
                          row.leastAmount
                        )}</td>
                    </tr>`
            )
            .join("");
        } else {
          thead.innerHTML = `<tr><th rowspan="2">Sl. No.</th><th rowspan="2">Description of Items</th>
                    <th rowspan="2">Unit</th><th rowspan="2">Qty</th><th colspan="2">Estimate</th>
                    ${bidderNames
                      .map((name) => `<th colspan="2">${name}</th>`)
                      .join("")}
                    <th colspan="2">Least Bid</th></tr>
                    <tr><th>Rate</th><th>Amount</th>
                    ${bidderNames
                      .map(() => `<th>Rate</th><th>Amount</th>`)
                      .join("")}
                    <th>Rate</th><th>Amount</th></tr>`;
          tbody.innerHTML = data
            .map((item, index) => {
              let rowClass = item.isSubtotal
                ? "subtotal-row"
                : item.isCategory
                ? "category-header"
                : item.isGrandTotal
                ? "grand-total-row"
                : "";
              const leastBid = findLeastBid(item);
              const isEditable =
                !item.isSubtotal && !item.isGrandTotal && !item.isCategory;
              return `<tr class="${rowClass}">
                        <td>${item.slNo}</td><td>${item.description}</td><td>${
                item.unit
              }</td>
                        <td class="amount-cell">${item.qty || ""}</td>
                        <td class="amount-cell">${
                          isEditable ? formatCurrency(item.estimate.rate) : ""
                        }</td>
                        <td class="amount-cell">${formatCurrency(
                          item.estimate.amount
                        )}</td>
                      ${item.bidders
                        .map((bidder, i) => {
                          const estRate = item.estimate.rate || 0;
                          let rateClass = "";
                          const isLeastRate =
                            leastBid.rate > 0 && leastBid.rate === bidder.rate;

                          // Determine color class based on % difference from estimate
                          const { lower, upper } = getVarianceThresholds();

                          if (estRate > 0 && bidder.rate > 0) {
                            const ratio = bidder.rate / estRate;
                            if (ratio < lower)
                              rateClass = "bg-blue-100"; // Below threshold
                            else if (ratio > upper) rateClass = "bg-orange-100"; // Above threshold
                          }

                          return `<td class="${
                            isLeastRate ? "least-rate-cell" : ""
                          }">
      <input type="number" class="rate-input ${rateClass}" value="${
                            bidder.rate
                          }" data-row-index="${index}" data-bidder-index="${i}" onchange="handleRateChange(this, '${sheetName}')" ${
                            !isEditable ? "disabled" : ""
                          }>
    </td>
    <td class="amount-cell">${formatCurrency(bidder.amount)}</td>`;
                        })
                        .join("")}

<td class="least-rate-cell">${
                isEditable ? formatCurrency(leastBid.rate) : ""
              }</td>
<td class="least-amount-cell">${
                isEditable ? formatCurrency(leastBid.amount) : ""
              }</td></tr>`;
            })
            .join("");
        }
        table.append(thead, tbody);
        tableWrapper.appendChild(table);
        tablesContainer.appendChild(tableWrapper);
      }

      function handleRateChange(input, sheetName) {
        const rowIndex = parseInt(input.dataset.rowIndex);
        const bidderIndex = parseInt(input.dataset.bidderIndex);
        const newRate = parseFloat(input.value) || 0;
        if (consolidatedData[sheetName]?.[rowIndex]) {
          consolidatedData[sheetName][rowIndex].bidders[bidderIndex].rate =
            newRate;
        }
        calculateAllTotals();
        const activeTab =
          document.querySelector(".tab-button.active").dataset.sheet;
        renderTableForSheet(activeTab);
        setTimeout(() => {
          const newElement = document.querySelector(
            `#table-${sheetName.replace(
              /\s|&/g,
              "-"
            )} [data-row-index="${rowIndex}"][data-bidder-index="${bidderIndex}"]`
          );
          if (newElement) {
            newElement.focus();
            newElement.setSelectionRange(
              newElement.value.length,
              newElement.value.length
            );
          }
        }, 0);
      }

      // --- CALCULATION LOGIC (FINAL REWRITE) ---
      function calculateAllTotals() {
        let summarySheetData = {};

        for (const sheetName of Object.keys(consolidatedData)) {
          if (sheetName === "Summary") continue;
          const sheetData = consolidatedData[sheetName];

          // Pass 1: Calculate all individual line item amounts. This is the foundation.
          sheetData.forEach((item) => {
            if (!item.isSubtotal && !item.isGrandTotal && !item.isCategory) {
              item.bidders.forEach(
                (bidder) => (bidder.amount = item.qty * bidder.rate)
              );
              item.estimate.amount = item.qty * item.estimate.rate;
            }
          });

          // Pass 2: Calculate Sub-Totals by summing up preceding items.
          let currentSubTotal = {
            estimate: 0,
            bidders: Array(bidderNames.length).fill(0),
          };
          sheetData.forEach((item) => {
            if (item.isCategory) {
              // Reset at the start of a new major category
              currentSubTotal = {
                estimate: 0,
                bidders: Array(bidderNames.length).fill(0),
              };
            } else if (item.isSubtotal) {
              // Assign the accumulated total and then reset
              item.estimate.amount = currentSubTotal.estimate;
              item.bidders.forEach(
                (b, idx) => (b.amount = currentSubTotal.bidders[idx])
              );
              currentSubTotal = {
                estimate: 0,
                bidders: Array(bidderNames.length).fill(0),
              };
            } else if (!item.isGrandTotal) {
              // Accumulate amounts for regular items
              currentSubTotal.estimate += item.estimate.amount;
              item.bidders.forEach((bidder, idx) => {
                currentSubTotal.bidders[idx] += bidder.amount;
              });
            }
          });

          // Pass 3: Create a definitive master map of category totals from the source line items.
          const categoryTotalsMap = {};
          sheetData.forEach((item) => {
            if (item.slNo && String(item.slNo).includes(".")) {
              const categoryKey = String(item.slNo).split(".")[0];
              if (!categoryTotalsMap[categoryKey]) {
                categoryTotalsMap[categoryKey] = {
                  estimate: 0,
                  bidders: Array(bidderNames.length).fill(0),
                };
              }
              categoryTotalsMap[categoryKey].estimate += item.estimate.amount;
              item.bidders.forEach((bidder, idx) => {
                categoryTotalsMap[categoryKey].bidders[idx] += bidder.amount;
              });
            }
          });

          // Pass 4: Update summary-at-the-bottom rows using the definitive map.
          sheetData.forEach((item) => {
            const slNoStr = String(item.slNo);
            if (item.isCategory) {
              const totals = categoryTotalsMap[slNoStr];
              if (totals) {
                item.estimate.amount = totals.estimate;
                item.bidders.forEach((b, idx) => {
                  b.amount = totals.bidders[idx];
                });
              }
            }
          });

          // Pass 5: Calculate Grand Total from the definitive map.
          const grandTotal = {
            estimate: 0,
            bidders: Array(bidderNames.length).fill(0),
          };
          Object.values(categoryTotalsMap).forEach((sub) => {
            grandTotal.estimate += sub.estimate;
            grandTotal.bidders.forEach(
              (val, idx) => (grandTotal.bidders[idx] += sub.bidders[idx])
            );
          });

          const grandTotalRow = sheetData.find((item) => item.isGrandTotal);
          if (grandTotalRow) {
            grandTotalRow.estimate.amount = grandTotal.estimate;
            grandTotalRow.bidders.forEach(
              (b, idx) => (b.amount = grandTotal.bidders[idx])
            );
          }

          summarySheetData[sheetName] = {
            estimateAmount: grandTotal.estimate,
            bidderAmounts: grandTotal.bidders,
          };
        }
        buildSummarySheet(summarySheetData);
      }

      function buildSummarySheet(summaryData) {
        let summaryRows = [];
        let total = {
          estimateAmount: 0,
          bidderAmounts: Array(bidderNames.length).fill(0),
        };
        SHEET_NAMES.forEach((sheetName) => {
          if (summaryData[sheetName]) {
            const totals = summaryData[sheetName];
            const validBids = totals.bidderAmounts.filter((a) => a > 0);
            const leastAmount =
              validBids.length > 0 ? Math.min(...validBids) : 0;
            summaryRows.push({
              slNo: summaryRows.length + 1,
              description: sheetName.replace("BOQ-", ""),
              estimateAmount: totals.estimateAmount,
              bidderAmounts: totals.bidderAmounts,
              leastAmount: leastAmount,
            });
            total.estimateAmount += totals.estimateAmount;
            totals.bidderAmounts.forEach(
              (a, i) => (total.bidderAmounts[i] += a)
            );
          }
        });
        const validTotalBids = total.bidderAmounts.filter((a) => a > 0);
        total.leastAmount =
          validTotalBids.length > 0 ? Math.min(...validTotalBids) : 0;
        summaryRows.push({
          ...total,

          slNo: "",
          description: "GRAND TOTAL",
          isTotal: true,
        });
        consolidatedData.Summary = summaryRows;
      }

      // --- UTILITY FUNCTIONS ---
      function findLeastBid(item) {
        if (!item.bidders || item.bidders.length === 0 || !item.qty) {
          return { rate: 0, amount: 0 };
        }
        const validBids = item.bidders.filter((b) => b.rate > 0);
        if (validBids.length === 0) return { rate: 0, amount: 0 };
        const leastBid = validBids.reduce(
          (min, current) => (current.rate < min.rate ? current : min),
          validBids[0]
        );
        return { rate: leastBid.rate, amount: leastBid.rate * item.qty };
      }

      function formatCurrency(num) {
        if (typeof num !== "number" || !isFinite(num)) return "0";
        return new Intl.NumberFormat("en-IN", {
          maximumFractionDigits: 0,
        }).format(num);
      }


















async function handleDownloadExcelJS() {
  const workbook = new ExcelJS.Workbook();

  // --- Inputs with validation defaults ---
  const defaultProject = "Proposed Industrial Building for M/s DGG Exports Pvt. Ltd At Shiggaon, Karnataka";
  const projectName = (prompt("Enter Project Name:", defaultProject) || defaultProject).trim();

  const lowInput = parseFloat(prompt("Enter LOW variance threshold (e.g., 0.8):", "0.8"));
  const highInput = parseFloat(prompt("Enter HIGH variance threshold (e.g., 1.2):", "1.2"));
  const selectedVarianceLow = Number.isFinite(lowInput) ? lowInput : 0.8;
  const selectedVarianceHigh = Number.isFinite(highInput) ? highInput : 1.2;

  const sheetsToDownload = SHEET_NAMES.filter(
    (name) => consolidatedData[name] && consolidatedData[name].length > 0
  );

  // --- Helpers ---
  const RATE_FMT = "#,##0.00";
  const AMT_FMT  = "#,##0";
  const isSummary = (n) => n === "Summary";

  // Give Excel better wrap points in long descriptions
  const insertWrapHints = (txt) => {
    if (txt == null) return "";
    const s = String(txt)
      .replace(/\s+/g, " ")
      .replace(/\//g, "/\u200b")
      .replace(/-/g, "-\u200b");
    return s.trim();
  };

  // Neat Sl. No without floating garbage like 4.109999
  const formatSlNo = (val) => {
    if (val == null) return "";
    if (typeof val === "number") {
      // round to 3 decimals, then strip trailing zeros/dot
      const rounded = Math.round((val + Number.EPSILON) * 1000) / 1000;
      let s = String(rounded);
      if (/e/i.test(s)) s = rounded.toFixed(6); // expand scientific if any
      s = s.replace(/(\.\d*?[1-9])0+$/,"$1").replace(/\.0+$/,"");
      return s;
    }
    const str = String(val).trim();
    if (/^\d+(\.\d+)?$/.test(str)) return formatSlNo(parseFloat(str));
    return str; // keep non-numeric labels (e.g., "Sub-Total") untouched
  };

  // Excel can't auto-fit row height; estimate based on text length vs col width
  const estimateRowHeight = (text, colWidth, lineHeight = 16, min = 18, max = 120) => {
    const s = (text || "").toString();
    if (!s) return min;
    const hardLines = s.split(/\r\n|\n/);
    const perLineCap = Math.max(1, Math.floor(colWidth * 1.1));
    let logicalLines = 0;
    for (const ln of hardLines) {
      logicalLines += Math.max(1, Math.ceil(ln.length / perLineCap));
    }
    return Math.min(max, Math.max(min, logicalLines * lineHeight));
  };

  for (const sheetName of sheetsToDownload) {
    const sheet = workbook.addWorksheet(sheetName.substring(0, 31));

    // --- Header Rows (common) ---
    sheet.mergeCells("A1", "E1");
    sheet.getCell("A1").value = `Project  : ${projectName}`;
    sheet.getCell("A1").font = { bold: true };
    sheet.getCell("A1").alignment = { horizontal: "left", vertical: "middle" };

    sheet.mergeCells("A2", "E2");
    sheet.getCell("A2").value = `Scope : Civil Works`;
    sheet.getCell("A2").font = { bold: true };
    sheet.getCell("A2").alignment = { horizontal: "left", vertical: "middle" };

    sheet.getCell("F1").value = `Low: ${selectedVarianceLow}`;
    sheet.getCell("F1").fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFBFD7EA" } };
    sheet.getCell("F1").alignment = { horizontal: "center", vertical: "middle" };

    sheet.getCell("F2").value = `High: ${selectedVarianceHigh}`;
    sheet.getCell("F2").fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFFD2B3" } };
    sheet.getCell("F2").alignment = { horizontal: "center", vertical: "middle" };

    sheet.getCell("G1").value = `Date: ${new Date().toLocaleDateString()}`;
    sheet.getCell("G1").alignment = { horizontal: "right", vertical: "middle" };

    sheet.getCell("G2").value = `Rev: R0`;
    sheet.getCell("G2").alignment = { horizontal: "right", vertical: "middle" };

    sheet.getRow(1).height = 28;
    sheet.getRow(2).height = 24;
    sheet.getColumn("F").width = 20;
    sheet.getColumn("G").width = 20;

    // --- Content ---
    if (isSummary(sheetName)) {
      // SUMMARY
      sheet.addRow([]); // spacer
      const headers = [
        "Sl. No",
        "Description",
        "Estimate Amount",
        ...bidderNames.map((name) => `${name} Amount`),
        "Least Amount"
      ];
      const headerRow = sheet.addRow(headers);
      headerRow.font = { bold: true };
      headerRow.alignment = { horizontal: "center", vertical: "middle", wrapText: true };
      headerRow.height = 28;

      consolidatedData.Summary.forEach((row) => {
        const newRow = sheet.addRow([
          formatSlNo(row.slNo),                         // <<< cleaned
          insertWrapHints(row.description),
          row.estimateAmount,
          ...row.bidderAmounts,
          row.leastAmount
        ]);

        // Description alignment + height
        const descColWidth = 60; // wider Summary description per your request
        newRow.getCell(2).alignment = { horizontal: "left", vertical: "top", wrapText: true };
        newRow.height = estimateRowHeight(newRow.getCell(2).value, descColWidth);

        // Variance shading on bidder amounts
        row.bidderAmounts.forEach((amt, idx) => {
          const est = row.estimateAmount || 0;
          const variance = est ? amt / est : 0;
          const cell = newRow.getCell(4 + idx);
          if (est && variance < selectedVarianceLow) {
            cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFBFD7EA" } };
          } else if (est && variance > selectedVarianceHigh) {
            cell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFFD2B3" } };
          }
        });

        if ((row.description || "").toString().toUpperCase().includes("GRAND TOTAL")) {
          newRow.font = { bold: true };
        }
      });

      // Column widths & alignment for Summary (Sl. No small, Description large)
      sheet.columns.forEach((col, idx1) => {
  const idx = idx1; // 1-based
  if (idx === 1) { 
    col.width = 25; // adjust for discription of summary page 
    col.alignment = { horizontal: "center", vertical: "middle", wrapText: true };
  }
  else if (idx === 2) { 
    col.width = 10; // wider Description
    col.alignment = { horizontal: "left", vertical: "top", wrapText: true };
  }
  else { 
    col.width = 18;   // rates
    col.alignment = { horizontal: "right", vertical: "middle", wrapText: true };
    col.numFmt = AMT_FMT; 
  }
});

      sheet.views = [{ state: "frozen", ySplit: 4 }];

    } else {
      // NON-SUMMARY (BOQ) PAGES
      const header1 = [
        "Sl. No.",
        "Description of Items",
        "Unit",
        "Estimated", "", "",
        ...bidderNames.flatMap((name) => [name, ""]),
        "Least Bid", ""
      ];
      const header2 = [
        "", "", "", "Qty", "Rate", "Amount",
        ...bidderNames.flatMap(() => ["Rate", "Amount"]),
        "Rate", "Amount"
      ];

      sheet.addRow([]); // spacer
      const h1 = sheet.addRow(header1);
      const h2 = sheet.addRow(header2);

      // Merge header groups
      sheet.mergeCells(4, 4, 4, 6);
      bidderNames.forEach((_, i) => {
        const startCol = 7 + i * 2;
        sheet.mergeCells(4, startCol, 4, startCol + 1);
      });
      const leastStart = 7 + bidderNames.length * 2;
      sheet.mergeCells(4, leastStart, 4, leastStart + 1);

      [h1, h2].forEach((row) => {
        row.font = { bold: true };
        row.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFCE4D6" } };
        row.alignment = { horizontal: "center", vertical: "middle", wrapText: true };
        row.height = 28;
      });

      // Column widths (nice wide Description)
      const descWidth = 72;
      const baseWidths = [9, descWidth, 10, 12, 12, 14];
      const bidderWidths = bidderNames.flatMap(() => [12, 14]);
      const leastWidths = [12, 14];
      [...baseWidths, ...bidderWidths, ...leastWidths]
        .forEach((w, i) => sheet.getColumn(i + 1).width = w);

      // Data rows
      consolidatedData[sheetName].forEach((item) => {
        const leastBid = findLeastBid(item);
        const isEditable = !item.isSubtotal && !item.isGrandTotal && !item.isCategory;
        const prettyDesc = insertWrapHints(item.description);

        const newRow = sheet.addRow([
          formatSlNo(item.slNo),                        // <<< cleaned
          prettyDesc,
          item.unit,
          item.qty ?? null,
          isEditable ? item.estimate.rate : null,
          item.estimate.amount,
          ...item.bidders.flatMap((b) => [isEditable ? b.rate : null, b.amount]),
          isEditable ? leastBid.rate : null,
          isEditable ? leastBid.amount : null,
        ]);

        // Alignments
        newRow.getCell(1).alignment = { vertical: "top", horizontal: "left",  wrapText: true };
        newRow.getCell(2).alignment = { vertical: "top", horizontal: "left",  wrapText: true };
        newRow.getCell(3).alignment = { vertical: "top", horizontal: "center",wrapText: true };
        newRow.getCell(4).alignment = { vertical: "top", horizontal: "right", wrapText: true };
        newRow.getCell(4).numFmt = AMT_FMT;

        newRow.getCell(5).alignment = { vertical: "top", horizontal: "right", wrapText: true };
        newRow.getCell(5).numFmt = RATE_FMT;
        newRow.getCell(6).alignment = { vertical: "top", horizontal: "right", wrapText: true };
        newRow.getCell(6).numFmt = AMT_FMT;

        // Bidder pairs
        for (let i = 0; i < bidderNames.length; i++) {
          const rateCell = newRow.getCell(7 + i * 2);
          const amtCell  = newRow.getCell(7 + i * 2 + 1);
          rateCell.alignment = { vertical: "top", horizontal: "right", wrapText: true };
          rateCell.numFmt = RATE_FMT;
          amtCell.alignment  = { vertical: "top", horizontal: "right", wrapText: true };
          amtCell.numFmt  = AMT_FMT;
        }

        // Least Bid cells
        const leastStartCol = 7 + bidderNames.length * 2;
        newRow.getCell(leastStartCol).alignment     = { vertical: "top", horizontal: "right", wrapText: true };
        newRow.getCell(leastStartCol).numFmt        = RATE_FMT;
        newRow.getCell(leastStartCol + 1).alignment = { vertical: "top", horizontal: "right", wrapText: true };
        newRow.getCell(leastStartCol + 1).numFmt    = AMT_FMT;

        // Variance shading on bidder RATE vs estimate RATE
        item.bidders.forEach((b, i) => {
          const estRate = item.estimate.rate || 0;
          if (estRate && b.rate) {
            const variance = b.rate / estRate;
            const rateCell = newRow.getCell(7 + i * 2);
            if (variance < selectedVarianceLow) {
              rateCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFBFD7EA" } };
            } else if (variance > selectedVarianceHigh) {
              rateCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFFD2B3" } };
            }
          }
        });

        // Tidy row height based on description
        newRow.height = estimateRowHeight(prettyDesc, descWidth);
      });

      sheet.views = [{ state: "frozen", ySplit: 5 }];
    }

    // --- Borders everywhere (no alignment override) ---
    sheet.eachRow((row) => {
      row.eachCell((cell) => {
        cell.border = {
          top: { style: "thin" },
          left: { style: "thin" },
          bottom: { style: "thin" },
          right: { style: "thin" }
        };
      });
    });
  }

  // Generate and download
  const buffer = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buffer], {
    type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
  });
  saveAs(blob, "DGG_Civil_CS_Consolidated_Output.xlsx");
}







    </script>
  </body>
</html>
